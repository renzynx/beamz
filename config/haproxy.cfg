global
    daemon
    log stdout local0 info

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global
    option httplog

# HAProxy listens on port 3333 and routes /api to the API service and all other
# requests to the web server. This preserves the /api path when forwarding.
frontend beam_frontend
    bind *:3333
    
    # Route API requests to API backend
    acl is_api path_beg /api/
    use_backend beam_api if is_api
    
    # Route all other requests to web backend
    default_backend beam_web

backend beam_api
    balance roundrobin
    # Healthcheck against the API health endpoint
    option httpchk GET /api/health
    server beam_api_1 beam:3333 check

backend beam_web
    balance roundrobin
    # Healthcheck against root of web server
    option httpchk GET /
    server beam_web_1 beam:3000 check
